<%#
 Copyright 2018 Lienol
 Licensed to the public under the Apache License 2.0.
-%>

<%
local dsp = require "luci.dispatcher"
-%>

<% include("cbi/map") %>
<script type="text/javascript">//<![CDATA[
	var tcp_redir_status = document.getElementById('_tcp_redir_status');
	var udp_redir_status = document.getElementById('_udp_redir_status');
	var socks5_proxy_status = document.getElementById('_socks5_proxy_status');
	var haproxy_status = document.getElementById('_haproxy_status');
	var kcptun_status = document.getElementById('_kcptun_status');
	var china_status = document.getElementById('_china_status');
	var foreign_status = document.getElementById('_foreign_status');
	XHR.poll(3,'<%=dsp.build_url("admin/vpn/passwall/server_status")%>', null,
		function(x, json) {
			if (x && x.status == 200) {
				if (tcp_redir_status)
					tcp_redir_status.innerHTML = json.tcp_redir_status ? '<font color=green><%:RUNNING%> ✓</font>' : '<font color=red><%:NOT RUNNING%> X</font>';
				if (udp_redir_status)
					udp_redir_status.innerHTML = json.udp_redir_status ? '<font color=green><%:RUNNING%> ✓</font>' : '<font color=red><%:NOT RUNNING%> X</font>';
				if (socks5_proxy_status)
					socks5_proxy_status.innerHTML = json.socks5_proxy_status ? '<font color=green><%:RUNNING%> ✓</font>' : '<font color=red><%:NOT RUNNING%> X</font>';
				if (haproxy_status)
					haproxy_status.innerHTML = json.haproxy_status ? '<font color=green><%:RUNNING%> ✓</font>' : '<font color=red><%:NOT RUNNING%> X</font>';
				if (kcptun_status)
					kcptun_status.innerHTML = json.kcptun_status ? '<font color=green><%:RUNNING%> ✓</font>' : '<font color=red><%:NOT RUNNING%> X</font>';
			}
		});
	var pings = document.getElementsByClassName('pingtime');
	for(var i = 0; i<pings.length; i++)
	{
		XHR.get('<%=dsp.build_url("admin/vpn/passwall/ping")%>', {index: i, domain: pings[i].getAttribute("hint")},
			function(x, result)
			{
				pings[result.index].innerHTML = (result.ping?result.ping:"--") + " ms";
			}
		);
	}
	
	function check_connect(btn,type)
	{
		btn.disabled = true;
		btn.value    = '<%:Check...%>';
		XHR.get('<%=dsp.build_url("admin/vpn/passwall/connect_status")%>',
			{ type:type },
			function(x,rv)
			{
				var s = document.getElementById('_'+type+'_status');
				if (s)
				{
					if (rv.status)
						s.innerHTML ='<font color=green><%:Working...%> ✓</font>';
					else
						s.innerHTML ='<font color=red><%:Problem detected!%> X</font>';
				}
				btn.disabled = false;
				btn.value = '<%:Check%>';
			}
		);
		return false;
	}
	
	function check_port(btn)
	{
		btn.disabled = true;
		btn.value = '<%:Check...%>';
		XHR.get('<%=dsp.build_url("admin/vpn/passwall/check_port")%>',null,
			function(x,rv)
			{
				var s = document.getElementById('_server_status');
				if (s)
				{
					s.innerHTML =rv.ret;
					var clear_btn = document.getElementById('clear_check_port_btn');
					clear_btn.style.display = "inline-block";
				}
				btn.disabled = false;
				btn.value = '<%:Check%>';
			}
		);
		return false;
	}
	
	function clear_check_port(btn)
	{
		btn.style.display = 'none'; 
		var s = document.getElementById('_server_status');
		s.innerHTML = "";
		return false;
	}
//]]></script>
